<!DOCTYPE html>
<html>
<head>
    <title>Consulta API Braskem</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <script src="https://unpkg.com/pyodide-http@0.1.0/pyodide_http.js"></script>
</head>
<body>
    <h2>Consulta de Vale Pedágio</h2>
    <label for="cnpj">CNPJ:</label><input type="text" id="cnpj" placeholder="Digite o CNPJ (somente números)">
    <label for="doc_transporte">DOC_TRANSPORTE:</label><input type="text" id="doc_transporte" placeholder="Digite a OT (mínimo 4 caracteres)">
    <button onclick="run()">Executar</button>
    <pre id="output"></pre>

    <script>
        async function run() {
            let pyodide = await loadPyodide();
            await pyodide.loadPackage("micropip");
            await pyodide.runPythonAsync(`
                import micropip
                await micropip.install('pyodide-http')
                await micropip.install('requests')
            `);

            // Carrega e registra o arquivo Python como módulo
            const response = await fetch('api_braskem_pyodide.py');
            const pyScript = await response.text();
            await pyodide.runPythonAsync(`
                import sys
                module_code = '''${pyScript.replace(/'/g, "\\'").replace(/\n/g, '\\n')}'''
                exec(module_code, sys.modules.setdefault('api_braskem_pyodide', {}))
            `);

            let cnpj = document.getElementById('cnpj').value;
            let doc_transporte = document.getElementById('doc_transporte').value;
            if (!cnpj || !doc_transporte) {
                document.getElementById('output').textContent = "Preencha todos os campos.";
                return;
            }
            await pyodide.runPythonAsync(`
                from api_braskem_pyodide import run_script
                run_script("${cnpj}", "${doc_transporte}")
            `);
            let output = pyodide.runPython("''.join(sys.stdout.getvalue().splitlines())") || "Executando... Veja o console para debug.";
            document.getElementById('output').textContent = output;
        }

        // Redireciona print para o HTML
        pyodide.runPython(`
            import sys
            from js import document
            sys.stdout = sys.stderr
            def print(*args, **kwargs):
                output = ' '.join(str(arg) for arg in args)
                document.getElementById('output').textContent += output + '\\n'
            __builtins__.print = print
        `);
    </script>
</body>
</html>